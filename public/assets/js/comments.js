
require(['jquery','lib/tinymce/jquery.tinymce'],function($){'use strict';var Engine={processing:false,setup:function(){Engine.mkCommentsForm(0,false,coreEngine.csrf_token);$(".js-action-reply").live('click',function(){var id;id=$(this).data('id');if($("#"+"reply-content-"+id).length===0){Engine.mkCommentsForm(id,true,coreEngine.csrf_token);}});$(".js-action-delete").live('click',function(){var $this=$(this),postData='cid='+$this.data('id'),$commentCount,commentCount;if(window.confirm("Are you sure?")){$this.closest('.comment-a').addClass('js-comment-delete');coreEngine.ajax('comments/delete/'+(new Date()).getTime(),postData,function(result){if(result.isError){$.message(result.strError,'error');}else{$commentCount=$('#comments').find('.comment-count');commentCount=parseInt($commentCount.text(),10);commentCount=isNaN(commentCount)?0:commentCount;$commentCount.text(commentCount-1);$('.js-comment-delete').remove();}},'json');return true;}else{return false;}});},tinyMCEditor:function(id){$('#'+id).tinymce({script_url:coreEngine.siteRoot+'assets/js/lib/tinymce/tiny_mce_src.js?'+coreEngine.version,content_css:coreEngine.siteRoot+'assets/css/screen.css?'+coreEngine.version,theme:"advanced",theme_advanced_buttons1:"bold,italic,|,sub,sup,|,bullist,numlist,|,undo,redo,|,spellchecker",theme_advanced_buttons2:"",theme_advanced_buttons3:"",plugins:"spellchecker,paste",paste_strip_class_attributes:"all",paste_remove_spans:true,paste_postprocess:function(pl,o){o.node.innerHTML=o.node.innerHTML.replace(/<p.*>\s*(<br>|&nbsp;)\s*<\/p>/ig,"");},setup:function(ed){ed.onKeyUp.add(function(ed){var strip=(ed.getContent()).replace(/(<([^>]+)>)/ig,"").replace(/&nbsp;/g," "),stripLen=strip.length,id=ed.editorId;id=id.substring(14,id.length);$("#wordcount-"+id).html(stripLen+"/400 characters");if(stripLen>400){strip=strip.substring(0,400);ed.execCommand('mceSetContent',false,strip);}});}});},mkCommentsForm:function(id,includeResponse,csrf_token){var form_action='comments/add',$span=$("<span>",{"class":"wordcount","id":"wordcount-"+id}).text("0/400 characters"),$form=$("<form>",{"action":coreEngine.siteRoot+form_action,"method":"post","class":"section-a"}),$title=$("<h3>",{"class":"offset"}).text('Post a comment'),$csrf=$("<input>",{"type":"hidden","name":"csrf_fishnet"}).val(csrf_token),$pageID=$("<input>",{"type":"hidden","name":"page_id"}).val(coreEngine.pageID),$textarea=$("<textarea>",{"id":"reply-content-"+id,"name":"content"}),$subscribe=$('<p>'),$submit=$("<button>").attr("id","btnSubmit-"+id).text('Submit Comment').button({icons:{primary:"ui-icon-comment"}});$submit.bind('click dblclick',function(){if(Engine.processing!==true){Engine.processing=true;$form.trigger('submit');}
return false;});$subscribe.append($("<input>",{"name":"subscribe","id":"sub-"+id,"type":"radio","value":"true","checked":"checked"})).append($('<label>',{"for":"sub-"+id}).text('Subscribe')).append($("<input>",{"name":"subscribe","id":"unsub-"+id,"type":"radio","value":"false"})).append($('<label>',{"for":"unsub-"+id}).text('Don\'t Subscribe'));$form.append($title).append($csrf).append($pageID);if(includeResponse){$form.append($("<input>",{"type":"hidden","name":"response_to"}).val(id));}
$form.append($("<p>").append($textarea)).append($subscribe).append($("<p>").append($submit)).submit(function(){tinymce.triggerSave();coreEngine.ajax(form_action,$(this).serialize(),Engine.commentCallback,'json');if(includeResponse){$("#"+"comment-reply-"+id).empty();}
return false;});$("#"+"comment-reply-"+id).append($span).append($form);Engine.tinyMCEditor("reply-content-"+id);},commentCallback:function(result){var $comment,$commentCount,commentCount,hash;setTimeout(function(){Engine.processing=false;},20000);if(result.isError){$.message(result.errorStr,'error');}else{$comment=$(result.data.html).hide();if(result.data.response_to){$('#comment-'+result.data.response_to).after($comment.addClass('comment-reply'));hash="#comment-"+result.data.response_to;}else{$('#comments').find('>.comments>h3').after($comment);hash="#comments";}
$commentCount=$('#comments').find('.comment-count');commentCount=parseInt($commentCount.text(),10);commentCount=isNaN(commentCount)?0:commentCount;$commentCount.text(commentCount+1);document.location=hash;$comment.fadeIn('slow');$('textarea[name="content"]').val('');tinymce.activeEditor.setContent('');}}};Engine.setup();});