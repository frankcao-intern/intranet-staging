
require(['jquery','lib/fullcalendar','lib/jquery.sort','lib/jquery.maskedinput-1.2.2','lib/jquery.ba-hashchange'],function($){'use strict';var current_cals,Engine={parseDate:function(input){var parts=input.match(/(\d+)/g);return new Date(parts[0],parts[1]-1,parts[2]);},search:function(){$("#byDate").closest('form').submit(function(){return false;}).end().mask("99-9999").keyup(function(e){if(e.keyCode===13){$("#btnByDate").click();}
return false;});$("#btnByDate").click(function(){var $by_date=$("#byDate"),date=$by_date.val(),hash,view;hash=document.location.hash.split('/');if(!hash[0]){hash[0]=JSON.stringify([coreEngine.pageID]);}
if(!hash[1]){view=$('#calendar').fullCalendar('getView');hash[1]=view.name;}
date=date.split('-');hash[2]=date[1]+'-'+date[0]+'-'+1;$by_date.val('');document.location.hash=hash.join('/');return false;});},bigCalendar:function(){var color=$('.calendar-header').css('border-left-color'),$calendar=$('#calendar'),data;$calendar.empty().fullCalendar({slotMinutes:15,theme:true,buttonIcons:{prev:'triangle-1-w',next:'triangle-1-e'},header:{left:'',center:'title',right:'today month,agendaWeek,agendaDay prev,next'},weekMode:'fluid',titleFormat:{month:'MMMM yyyy',week:"MMMM d[, yyyy]{ '&#8212;'[ MMMM] d, yyyy}",day:"dddd, MMMM d, yyyy"},columnFormat:{month:'dddd'},eventClick:function(){return false;},editable:coreEngine.canPublish,eventDragStart:function(){$('.fc-event',$calendar).qtip('hide');},eventDrop:Engine.eventMoved,eventResize:Engine.eventResized,eventAfterRender:Engine.eventAfterRender,loading:function(isLoading){if(isLoading){$('#selectedCalendars').empty();}},selectable:coreEngine.canPublish,selectHelper:true,select:function(start,end,allDay){var event,postData,title=window.prompt('Event Title:',''),$calendar=$('#calendar');if(title){$calendar.fullCalendar('renderEvent',{title:title,start:start,end:end,allDay:allDay,color:'#FACE46',textColor:"#333"},true);event={event_title:title,start_date:$.fullCalendar.formatDate(start,'yyyy-MM-dd'),end_date:$.fullCalendar.formatDate(end,'yyyy-MM-dd'),start_time:$.fullCalendar.formatDate(start,'HH:mm:ss'),end_time:$.fullCalendar.formatDate(end,'HH:mm:ss'),sections:[coreEngine.pageID],event_desc:'',all_day:allDay?1:0};postData='events='+base64.encode(JSON.stringify([event]));coreEngine.ajax('calendar/newevent',postData,function(result){if(result.isError){$.message(result.errorStr,'error');}
$('#calendar').fullCalendar('refetchEvents');});}
$calendar.fullCalendar('unselect');}});data=$calendar.data('fullCalendar');data.options.viewDisplay=Engine.viewDisplay;$calendar.data('fullCalendar',data);if(!document.location.hash){Engine.addFeed(Number(coreEngine.pageID));Engine.viewDisplay($calendar.fullCalendar('getView'));}},eventAfterRender:function(event,element){$(element).qtip($.extend({},coreEngine.qtipDefaults,{content:{text:'Loading...',ajax:{url:$(element).attr('href')+'/layout/embed'},title:{text:'Event - '+$('.fc-event-title',element).text(),button:true}},show:{event:'click',solo:true},hide:{event:'unfocus'}}));},viewDisplay:function(view){var hash=document.location.hash.substr(1).split('/');if(hash[0]&&hash[1]!==view.name){hash[1]=view.name;document.location.hash=hash.join('/');}},hashChange:function(){$(window).hashchange(function(){var hash,viewName,view,cals,date,$calendar=$('#calendar');hash=location.hash.substr(1).split('/');if(hash[0]&&(current_cals!==hash[0])){$calendar.fullCalendar('removeAllEventSources');$('#selectedCalendars').empty();cals=JSON.parse(hash[0]);$(cals).each(function(idx,cal_id){var event_source={events:Engine.eventSource(cal_id),textColor:'#FFF'};$('#calendar').fullCalendar('addEventSource',event_source);});current_cals=hash[0];}
if(hash[1]){viewName=hash[1];view=$calendar.fullCalendar('getView');if((view.name!==viewName)){$calendar.fullCalendar('changeView',viewName);}}
if(hash[2]){date=Engine.parseDate(hash[2]);$calendar.fullCalendar('gotoDate',date);}}).trigger('hashchange');},eventSource:function(cal_id){return function(start,end,callback){var st=Math.round(start.getTime()/1000),fin=Math.round(end.getTime()/1000);coreEngine.getJSON('calendar/fullcal_json/'+cal_id+'/'+st+'/'+fin,'',function(eventData){var $selectedCalendars=$('#selectedCalendars');if($("li a[data-cal_id='"+eventData.cal_id+"']",$selectedCalendars).length===0){$selectedCalendars.append(coreEngine.attachTemplateToData('<li><span style="background: {{color}}"><\/span>'+'<a href="#" data-cal_id="{{cal_id}}">{{cal_name}}<\/a><\/li>',[{"cal_id":eventData.cal_id,"cal_name":eventData.cal_name,"color":eventData.color}])).find('li').sortElements(function(a,b){return $(a).text()>$(b).text()?1:-1;});}
callback(eventData.events);});};},eventMoved:function(event,dayDelta,minuteDelta,allDay,revertFunc){var e={},encodedEvent;e.event_id=event.id;e.dayDelta=dayDelta;e.minuteDelta=minuteDelta;encodedEvent=base64.encode(JSON.stringify(e));coreEngine.ajax('calendar/moveEvent',"event="+encodedEvent,function(result){if(result.isError){$.message(result.errorStr,'error');revertFunc();}},'json');},eventResized:function(event,dayDelta,minuteDelta,revertFunc){var e={},encodedEvent;e.event_id=event.id;e.dayDelta=dayDelta;e.minuteDelta=minuteDelta;encodedEvent=base64.encode(JSON.stringify(e));coreEngine.ajax('calendar/resizeEvent',"event="+encodedEvent,function(result){if(result.isError){$.message(result.errorStr,'error');revertFunc();}},'json');},addFeed:function(calID){var hash=document.location.hash.substr(1).split('/'),cals=[],cal_id=Number(calID),new_hash;if(hash[0]){cals=JSON.parse(hash[0]);if(cals.indexOf(cal_id)!==-1){return false;}
hash.splice(0,1);}
cals.push(cal_id);hash.unshift(JSON.stringify(cals));new_hash=hash.join('/');if(document.location.hash!==new_hash){document.location.hash=new_hash;}
return true;},addCalDiag:function(){$("#btnFeed").button().click(function(){$("#addCalDiag").dialog('open');});$("#addCalDiag").dialog({bgiframe:true,autoOpen:false,resizable:false,width:286,buttons:{'Add Calendar':function(){var cal_id=$("#acdCalID").val();Engine.addFeed(cal_id);$(this).dialog('close');},Cancel:function(){$(this).dialog('close');}},open:function(){$("#acdCalName, #acdCalID").val('');}});$("#acdCalName").autocomplete({minLength:1,source:function(request,response){coreEngine.getJSON('calendar/getall/'+base64.encode(request.term),'',response);},select:function(event,ui){if(ui.item.id){$("#acdCalID").val(ui.item.id);}}}).add("#acdCalID").keypress(function(e){var enterKey=e.keyCode===13;if(enterKey){$('.ui-dialog-buttonset button:first',$("#addCalDiag").parent()).click();}
return!enterKey;});},calendarList:function(){$('#selectedCalendars').on('click','li a',function(){var cal_id=$(this).data('cal_id'),hash=document.location.hash.substr(1).split('/'),cals;if(hash[0]){cals=JSON.parse(hash[0]);cals.splice(cals.indexOf(cal_id),1);hash[0]=JSON.stringify(cals);document.location.hash=hash.join('/');}
return false;});}};$(document).ready(function(){Engine.search();Engine.bigCalendar();Engine.addCalDiag();Engine.hashChange();Engine.calendarList();});});