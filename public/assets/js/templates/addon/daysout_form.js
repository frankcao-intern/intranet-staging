
(function($){var Engine={pad:function(n){return n<10?'0'+n:n},buttons:function(){$('.days-out button, .days-out input[type=submit]').button();$('#addDay').click(function(){var date=new Date(),dateStr=date.getFullYear()+'-'+Engine.pad(date.getMonth()+1)+'-'+Engine.pad(date.getDate());$('.days-out tbody').append(coreEngine.attachTemplateToData($('#dayTempl').text(),[{from:dateStr,to:dateStr,name:Number($('.days-out input[name=req_count]').val())+1}]));Engine.dates();Engine.calculateTotal();}).click();$('.days-out').delegate('.actions .delete','click',function(e){if($('.days-out tbody tr').length>1){$(this).closest('tr').remove();Engine.calculateTotal();}
return false;});$('.days-out').submit(function(){var $submit=$('input[type=submit]',this),total=Engine.calculateTotal(),invalid=false,requiredVal;$submit.attr('disabled','disabled');requiredVal=$('#location');requiredVal.removeClass('ui-state-error').each(function(i,obj){var $obj=$(obj);if($obj.val()===''){$obj.addClass('ui-state-error');$().message($obj.attr('name')+' is required.','error');invalid=true;return false;}});$('#mgrName').removeClass('ui-state-error');if($('input[name=mgr_id]').val()===''){$('#mgrName').addClass('ui-state-error');$().message("The leader's name is invalid, you need to select someone from the autocomplete list."+' Please try again.','error');$submit.removeAttr('disabled');return false;}
if(invalid){$submit.removeAttr('disabled');return false;}else{if(!total){$().message('You need have at least one requested day to submit the form.','error');$submit.removeAttr('disabled');return false;}
if(total>10){$().message('You can only submit a request for 10 days total, if you need to request/notify more '+'than 10 days than fill out another form for the additional days.','error');$submit.removeAttr('disabled');return false;}}
return true;});},dates:function(){$('.days-out tbody input').datepicker({dateFormat:"yy-mm-dd",onSelect:function(dateText,inst){var $this=$(this),$row=$this.parent().parent(),fromDate=Engine.parseDate($('input:first',$row).val()),$toDate=$('input:eq(1)',$row),toDate=Engine.parseDate($toDate.val()),fromDateStr=fromDate.getFullYear()+'-'+Engine.pad(fromDate.getMonth()+1)+'-'
+Engine.pad(fromDate.getDate());if(toDate<fromDate){$toDate.val(fromDateStr);toDate=fromDate;}
Engine.calculateRow($row,fromDate,toDate);Engine.calculateTotal();}});},useNotice:function(){$('input[name=use_notice]').click(function(){if(this.value==='0'){$('.days-out tbody input').datepicker('option','minDate',new Date()).datepicker('option','maxDate',null);}else{$('.days-out tbody input').datepicker('option','minDate',null).datepicker('option','maxDate',new Date());}}).filter(':eq(0)').click();},mgr:function(){$('#mgrName').keypress(function(){$('input[name=mgr_id]').val('');}).autocomplete({minLength:2,source:function(request,response){coreEngine.getJSON("who/search/qkey/displayname/q/"+Base64.encode(request.term),"",response);},select:function(event,ui){if(ui.item.id){$('input[name=mgr_id]').val(ui.item.id);$('input[name=mgr_email]').val(ui.item.email);}}});},parseDate:function(input){var parts=input.match(/(\d+)/g);return new Date(parts[0],parts[1]-1,parts[2]);},days_between:function(from,to){var ONE_DAY=1000*60*60*24,days,diff_ms;if(to<from){return 0;}
diff_ms=to.getTime()-from.getTime();days=Math.round(diff_ms/ONE_DAY);return days+1;},calculateRow:function($row,fromDate,toDate){var $tInput=$('td:eq(3) input',$row),$tSpan=$('td:eq(3) span',$row),days;if(!fromDate){fromDate=Engine.parseDate($('td:eq(1) input',$row).val());}
if(!toDate){toDate=Engine.parseDate($('td:eq(2) input',$row).val());}
days=Engine.days_between(fromDate,toDate);$tSpan.text(days);$tInput.val(days);},calculateTotal:function(){var $tr=$('.days-out tbody tr'),total=0,reqCount=$tr.length;$tr.each(function(i,obj){var days;Engine.calculateRow($(this));days=Number($('td:eq(3)',obj).text());total+=days;});$('.days-out tfoot td:last').text(total);$('.days-out input[name=total_days]').val(total);$('.days-out input[name=req_count]').val(reqCount);return total;}};$(document).ready(function(){Engine.buttons();Engine.dates();Engine.mgr();Engine.useNotice();});}(jQuery));